{% extends 'base.html' %}
{% load static %}


{% block title %} Canvas {% endblock %}
{% block script %}
<script src="{% static 'konva/konva.min.js' %}"></script> {% endblock %}
{% block style %}
<style>
    body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #f0f0f0;
    }
</style>
{% endblock %}

{% block content %}
<style>
    .toolbar-container {
        -webkit-box-pack: center;
        bottom: 15px;
        justify-content: center;
        display: flex;
        left: 0;
        margin: auto;
        position: absolute;
        right: 0;
        width: fit-content;
    }

    .toolbar {
        -webkit-box-pack: center;
        -webkit-box-align: center;
        background: floralwhite;
        align-items: center;
        border-radius: 32px;
        display: flex;
        font-family: Open sans, sans-serif;
        font-size: 12px;
        height: 40px;
        justify-content: center;
        padding: 0 5px;
        width: auto;
    }

    .toolbar .button-group {
        -webkit-box-align: center;
        align-items: center;
        -webkit-column-gap: 5px;
        column-gap: 5px;
        display: flex;
        height: 20px;
        padding: 0 5px;
    }

    .toolbar .button-group:not(:last-child) {
        border-right: 1px solid #000000;
        margin-left: 5px;
    }

    .toolbar .btn-outline-warning {
        margin-left: 0px;
        margin-top: 3px;
        margin-bottom: 3px;
        padding-right: 5px;
        padding-left: 7px;
        --bs-btn-border-color: #0000;
    }

</style>
<div id="container"></div>

<!-- Bottom Toolbar --->
<div class="toolbar-container">
    <div class="toolbar">
        <div class="button-group">
            <button class="btn btn-outline-warning zoom-out">
                <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 26 26" fill="none"
                     class="icon">
                    <path xmlns="http://www.w3.org/2000/svg"
                          d="M2 12C2 11.4477 2.44772 11 3 11H21C21.5523 11 22 11.4477 22 12C22 12.5523 21.5523 13 21 13H3C2.44772 13 2 12.5523 2 12Z"
                          fill="black"/>
                </svg>
            </button>
            <span class="zoom-value" id="zoom-value">100%</span>
            <button class="btn btn-outline-warning zoom-in">
                <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 26 26"
                     fill="none" class="icon">
                    <path xmlns="http://www.w3.org/2000/svg" d="M4 12H20M12 4V20" stroke="#000000" stroke-width="2"
                          stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
        <div class="button-group">
            <button class="btn btn-outline-warning new-node">
                <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 26 26"
                     fill="none" class="icon">
                    <path xmlns="http://www.w3.org/2000/svg"
                          d="M8 12H16M12 8V16M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z"
                          stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
            </button>
            <button class="btn btn-outline-warning new-transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 26 26"
                     fill="none" class="icon">

                    <path xmlns="http://www.w3.org/2000/svg"
                          d="M13 3H12C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21H13M17 8L21 12M21 12L17 16M21 12H9"
                          stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>

                </svg>
            </button>
            <button class="btn btn-outline-warning select-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 26 26"
                     fill="none" class="icon">

                    <path xmlns="http://www.w3.org/2000/svg"
                          d="M6.91304 19.4348L3 3L19.4348 6.91304L14.7391 10.0435L21 16.3043L16.3043 21L10.0435 14.7391L6.91304 19.4348Z"
                          stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>


                </svg>
            </button>
            <button class="btn btn-outline-warning move-button">
                <svg height="26" viewBox="0 0 26 26" width="26" xmlns="http://www.w3.org/2000/svg"
                     class="icon">

                    <path xmlns="http://www.w3.org/2000/svg"
                          d="M12 3V9M12 3L9 6M12 3L15 6M12 15V21M12 21L15 18M12 21L9 18M3 12H9M3 12L6 15M3 12L6 9M15 12H21M21 12L18 9M21 12L18 15"
                          stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>

                </svg>
            </button>
        </div>
    </div>
</div>
<script>

    var width = window.innerWidth;
    var height = window.innerHeight;
    var data = [{"x": width / 4, "y": height / 2 + 50}, {"x": width / 2, "y": height / 3}, {
        "x": width / 1.3,
        "y": height / 2
    }]

    // stage here
    var stage = new Konva.Stage({container: 'container', width: width, height: height, draggable: false});

    // layer
    var layer = new Konva.Layer();

    var stateGroup = new Konva.Group();

    var node = new Konva.Circle({
        x: 0,
        y: 0,
        radius: 15,
        fill: 'blue',
        name: "nodes",
        draggable: true,
    });

    var transition = new Konva.Arrow({
        points: [0, 0, 0, 0],
        pointerLength: 20,
        pointerWidth: 20,
        fill: 'black',
        stroke: 'black',
        strokeWidth: 5,
        lineJoin: 'round',
        tension: .45,
    })


    var circle2 = node.clone({
        x: data[2].x,
        y: data[2].y,
    });

    var arrow = transition.clone();

    var circle1 = node.clone({
        x: data[0].x,
        y: data[0].y,
    })


    let anchor = node.clone({
        x: data[1].x,
        y: data[1].y,
    })

    stateGroup.add(circle2, arrow, circle1, anchor)
    layer.add(stateGroup);

    arrow.points([circle1.position().x, circle1.position().y, anchor.position().x, anchor.position().y, circle2.position().x, circle2.position().y]);

    function updateLine() {
        arrow.points([circle1.position().x, circle1.position().y, anchor.position().x, anchor.position().y, circle2.position().x, circle2.position().y]);
        layer.draw();

    }

    stage.add(layer);


    $(document).on('click', '.zoom-out', function () {
        select("zoomOut");
    });
    $(document).on('click', '.zoom-in', function () {
        select("zoomIn");
    });
    $(document).on('click', '.select-button', function () {
        select("select");
    });
    $(document).on('click', '.move-button', function () {
        select("move");
    });

    var nodecounter = 0;

    stage.on('dblclick', function () {
        clone = node.clone({
            'x': stage.getPointerPosition().x,
            'y': stage.getPointerPosition().y,
            'id': nodecounter++,
        })
        layer.add(clone);
        layer.draw();
    });

    function createTransition() {

    }

    var moving = false;
    var initialX = 0;
    var initialY = 0;


    // When shift is pressed, don't move the nodes, otherwise move
    for (let node of stateGroup.children) {
        node.addEventListener('dragstart', function (evt) {
            moving = true;
            initialX = node.position().x;
            initialY = node.position().y;
        });

        node.addEventListener('dragmove', (evt) => {
            if (evt.shiftKey) {
                if (moving) {
                    node.setPosition({'x': initialX, 'y': initialY}) ;
                }
            } else {
                // Actions when the node is moving
                updateLine();
            }
        });

        node.addEventListener('dragend', function (evt) {
            moving = false;
        });
    }



    function select(tool) {

        var oldScale = stage.scaleX();
        var scaleBy = 1.05;
        stage.draggable(false);

        switch (tool) {
            case "zoomIn":
                var newScale = oldScale * scaleBy;
                var moveTo = {
                    x: (width / 2 - stage.x()) / oldScale,
                    y: (height / 2 - stage.y()) / oldScale,
                };

                stage.scale({'x': oldScale * scaleBy, 'y': oldScale * scaleBy});

                var newPos = {
                    x: width / 2 - moveTo.x * newScale,
                    y: height / 2 - moveTo.y * newScale,
                };
                stage.position(newPos);
                document.getElementById("zoom-value").textContent = (Number(newScale * 100).toFixed(0)) + '%';
                break;

            case "zoomOut":
                var newScale = oldScale / scaleBy;
                var moveTo = {
                    x: (width / 2 - stage.x()) / oldScale,
                    y: (height / 2 - stage.y()) / oldScale,
                };

                stage.scale({'x': oldScale / scaleBy, 'y': oldScale / scaleBy});

                var newPos = {
                    x: width / 2 - moveTo.x * newScale,
                    y: height / 2 - moveTo.y * newScale,
                };
                stage.position(newPos);
                document.getElementById("zoom-value").textContent = (Number(newScale * 100).toFixed(0)) + '%';
                break;

            case "select":
                break;
            case "move":
                stage.draggable(true);
                break;

            case "newNode":

                clone = node.clone({
                    x: stage.getPointerPosition().x,
                    y: stage.getPointerPosition().y,
                    id: 'myCircle'

                });

                break;

            case "transition":
                break;
        }
    }


</script>
{% endblock %}
